#!/bin/sh
set -e

WD="$(pwd)"

# Input directories
ZLIB_SRC="$(WD)/src/zlib-1.3.1"
HDF5_SRC="$(WD)/src/hdf5-1.14.6"
HDF5_PATCHES="$(WD)/src/hdf5-patches"

# Temporary staging directory
HDF5_PREFIX="$(WD)/src/hdf5_staging"

# Output directories
INST_INCLUDE="$(WD)/inst/include"
INST_LIB="$(WD)/inst/lib"


echo "--- [hdf5lib] Starting Unix configuration ---"

# --- Show our path assumptions ---
echo "--- [hdf5lib] zlib src path: ${ZLIB_SRC} ---"
echo "--- [hdf5lib] hdf5 src path: ${HDF5_SRC} ---"

# --- 1. Build static zlib ---
echo "--- [hdf5lib] Configuring and compiling static zlib..."
cd "$ZLIB_SRC"
CC="$CC" CFLAGS="$CFLAGS -fPIC" ./configure --static
make libz.a CFLAGS="$CFLAGS -fPIC"

# --- 2. Build static HDF5 ---
echo "--- [hdf5lib] Starting HDF5 build..."
cd "$HDF5_SRC"

# Export CFLAGS and LDFLAGS with zlib path AND -fPIC
export CFLAGS="$CFLAGS -fPIC -I${ZLIB_SRC}"
export LDFLAGS="$LDFLAGS -L${ZLIB_SRC}"

# Apply patches from the hdf5-patches directory
echo "--- [hdf5lib] Applying patches to HDF5 codebase..."
for patchfile in "$HDF5_PATCHES"/*.patch; do
  echo "Applying patch: $(basename "$patchfile")"
  patch -p0 < "$patchfile"
done

# Configure HDF5 with thread-safety enabled
echo "--- [hdf5lib] Configuring bundled HDF5 library..."
./configure \
  --prefix="$HDF5_PREFIX" \
  --disable-shared \
  --enable-static \
  --enable-threadsafe \
  --enable-unsupported \
  --disable-tests \
  --disable-tools \
  --disable-dependency-tracking \
  --without-szlib

# Compile HDF5 with warning suppressions
# Make sure make uses -fPIC if needed (configure should handle this via CFLAGS export)
echo "--- [hdf5lib] Compiling HDF5 static library..."
make CFLAGS="$CFLAGS -fPIC -Wno-deprecated-declarations -Wno-format -Wno-format-extra-args -Wno-implicit-fallthrough -Wno-unused-parameter -Wno-strict-prototypes -Wno-unused-function -Wno-unneeded-internal-declaration -Wno-sign-conversion -Wno-enum-enum-conversion"

echo "--- [hdf5lib] Installing HDF5 to staging directory..."
make install

# --- 3. Finalize R package ---
mkdir -p "$INST_INCLUDE"
mkdir -p "$INST_LIB"

echo "--- [hdf5lib] Exposing HDF5 and zlib static libraries..."
cp "$HDF5_PREFIX"/lib/libhdf5.a "$INST_LIB"/
cp "$ZLIB_SRC"/libz.a "$INST_LIB"/

echo "--- [hdf5lib] Exposing HDF5 headers..."
cp -r "$HDF5_PREFIX"/include/* "$INST_INCLUDE"/

echo "--- [hdf5lib] Creating Makevars for LinkingTo..."
echo "PKG_LIBS = -L'$(R_PACKAGE_LIB)' -lhdf5 -lz -lpthread -ldl" > "$INST_INCLUDE"/Makevars

echo "--- [hdf5lib] Cleaning up build-time directories..."
cd "$WD"
rm -rf "$HDF5_SRC"
rm -rf "$ZLIB_SRC"
rm -rf "$PATCHES"
rm -rf "$HDF5_PREFIX"


echo "--- [hdf5lib] Unix configuration complete. ---"
exit 0