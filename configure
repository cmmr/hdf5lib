#!/bin/sh
set -e

echo "--- [hdf5lib] Starting Unix configuration ---"

# --- 1. Build static zlib ---
echo "--- [hdf5lib] Configuring and compiling static zlib..."
cd src/zlib-1.3.1
# Add -fPIC to CFLAGS for zlib configure
CC="$CC" CFLAGS="$CFLAGS -fPIC" ./configure --static
# Make sure make also uses -fPIC if needed (though configure usually handles this)
make libz.a CFLAGS="$CFLAGS -fPIC"
cd ../..

# --- Store the absolute path to zlib ---
ZLIB_PATH="$(pwd)/src/zlib-1.3.1"
echo "--- [hdf5lib] zlib path set to: ${ZLIB_PATH} ---"

# --- 2. Build static HDF5 ---
echo "--- [hdf5lib] Starting HDF5 build..."
cd src/hdf5-1.14.6

# Export CFLAGS and LDFLAGS with zlib path AND -fPIC
export CFLAGS="$CFLAGS -fPIC -I${ZLIB_PATH}"
export LDFLAGS="$LDFLAGS -L${ZLIB_PATH}"

# Patch
echo "--- [hdf5lib] Applying R/MinGW patches..."
patch -p0 < ../hdf5.patch

# Configure HDF5 with thread-safety and dynamic loading enabled
echo "--- [hdf5lib] Configuring bundled HDF5 library..."
./configure \
  --disable-shared \
  --enable-static \
  --enable-threadsafe \
  --enable-dynamic-loading \
  --enable-unsupported \
  --disable-fortran \
  --disable-cxx \
  --disable-parallel \
  --disable-subfiling-vfd \
  --disable-direct-vfd \
  --disable-tests \
  --disable-tools \
  --disable-dependency-tracking \
  --without-szlib # Added for consistency

# Compile HDF5 with warning suppressions
# Make sure make uses -fPIC if needed (configure should handle this via CFLAGS export)
echo "--- [hdf5lib] Compiling HDF5 static library..."
make CFLAGS="$CFLAGS -fPIC -Wno-deprecated-declarations -Wno-format -Wno-format-extra-args -Wno-implicit-fallthrough -Wno-unused-parameter -Wno-strict-prototypes -Wno-unused-function -Wno-unneeded-internal-declaration -Wno-sign-conversion"
cd ../..

# --- 3. Finalize R package ---
echo "--- [hdf5lib] Creating Makevars..."
# Add -lpthread (threadsafe) AND -ldl (dynamic loading) linker flags
sed 's|$(ZLIB_LIB)|$(ZLIB_LIB) -lpthread -ldl|' src/Makevars.in > src/Makevars.in.tmp && mv src/Makevars.in.tmp src/Makevars.in
cp src/Makevars.in src/Makevars
# Restore Makevars.in in case this script is run again
git checkout -- src/Makevars.in

echo "--- [hdf5lib] Exposing HDF5 headers..."
mkdir -p inst/include
cp src/hdf5-1.14.6/src/*.h inst/include/
cp src/hdf5-1.14.6/hl/src/*.h inst/include/

echo "--- [hdf5lib] Unix configuration complete. ---"
exit 0